{{ template "header" . }}

<script type="text/javascript" class="init">

$(document).ready(function () {
  var collapsedGroups = {};

  $('#dining').DataTable({
    "pageLength": 50,
    "scrollY":    "70vh",
    "scrollCollapse": true,
    "paging": false,
    "order": [[1, "asc"], [0, "asc"]],
    "ajax": {
      "url": '?api=offers.json',
      "cache": true
    },
    "rowGroup": {
      dataSrc: ["Name"],
      startRender: function (rows, group) {
        var collapsed = !collapsedGroups[group];

        rows.nodes().each(function (r) {
          r.style.display = collapsed ? 'none' : '';
        });   
        return $('<tr/>')
          .append( '<td>'+rows.data().pluck('Location')[0]+'</td>')
          .append( '<td colspan="4"><a href="'+rows.data().pluck('URL')[0]+'" target="_blank">'+group+'</a></td>')
          .attr('data-name', group)
          .toggleClass('collapsed', collapsed);
      }
    },
    "columns": [ 
      { "title": "Location", "data": ".Location" },
      { "title": "Restaurant", "data": ".Name",
        "orderable": true,
        "render": 
          function (data, type, row) { 
            return row.Name;
          }
      },
      { "title": "Date", "data": ".Date",
        "orderable": false
      },
      { "title": "Meal", "data": ".Meal",
        "orderable": false
      },
      { "title": "Times", "data": ".Time",
        "orderable": false,
        "render": 
          function (data, type, row) { 
            return data.join(" - ");
          }
      }
    ]
  });

  $('#dining tbody').on('click', 'tr.dtrg-start', function () {
    var name = $(this).data('name');
    collapsedGroups[name] = !collapsedGroups[name];
//    $('#dining').DataTable().ajax.reload();
    $('#dining').DataTable().draw(false);
  });  

  $.getJSON('?api=update', (data) => {
    console.log(data.OffersTime);
    $('#Updated-Offers').text(new Date(data.OffersTime*1000).toISOString());
  });

  //setInterval( function() {$('#DHCPLeases').DataTable().ajax.reload(); }, 5000);
  });
</script> 

<h2>Last updated: <span id="Updated-Offers"></span></h2>

<table id="dining" class="table" style="width:90%">
  <thead>
    <tr>
      <th>Location</th>
      <th>Restaurant</th>
      <th>Date</th>
      <th>Meal</th>
      <th>Times</th>
    </tr>
  </thead>
</table>

{{ template "footer" . }}
<!-- vim: noai:ts=2:sw=2:set expandtab: -->

